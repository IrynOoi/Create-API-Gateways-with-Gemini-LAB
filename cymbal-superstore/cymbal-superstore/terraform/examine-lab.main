# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

//Updated Ray Causey, 1/24/2023

// import random string
resource "random_string" "image_tag" {
  length  = 16
  special = false
}

//Set to use the current project id
data "google_project" "project" {
}

locals {
  //  generate a 16 digit hexadecimal string 
  project_id           = data.google_project.project.project_id
  region               = "us-central1"
  app_name             = "cymbal-superstore"
  api_name             = "inventory-api"
  run_name             = "inventory"
  source_bucket_name   = "duet-appdev"
  docker_image_tag     = substr(md5(random_string.image_tag.result), 0, 16)
  frontend_bucket_name = "${local.project_id}-cymbal-frontend"
  frontend_static_ip   = "${local.project_id}-cymbal-frontend-ip"
  inventory_image_url  = "${local.region}-docker.pkg.dev/${local.project_id}/${local.app_name}/${local.api_name}:${local.docker_image_tag}"
}

// -------------  create folders and copy files  -----------------------------------------------------------------
resource "null_resource" "app" {
  provisioner "local-exec" {
    command = "mkdir -p ~/${local.app_name}"
  }
  // always run this on every terraform apply
  triggers = { always_run = timestamp() }
}

resource "null_resource" "download_files" {
  provisioner "local-exec" {
    command = "gsutil -m cp -r gs://${local.source_bucket_name}/${local.app_name} ~/"
  }
  // always run this on every terraform apply
  triggers = { always_run = timestamp() }
}

resource "null_resource" "delete_cloudfunction_code" {
  provisioner "local-exec" {
    command = "rm ~/cymbal-superstore/functions/*"
  }
  depends_on = [
    null_resource.download_files,
  ]
  // always run this on every terraform apply
  triggers = { always_run = timestamp() }
}

// -------------  ENABLE APIS -----------------------------------------------------------------

# resource "google_project_service" "storage" {
#   project                    = local.project_id
#   service                    = "storage.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }
# resource "google_project_service" "run" {
#   project                    = local.project_id
#   service                    = "run.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }
# resource "google_project_service" "firestore" {
#   project                    = local.project_id
#   service                    = "firestore.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }

# // -- Functions
# resource "google_project_service" "functions" {
#   project                    = local.project_id
#   service                    = "cloudfunctions.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }

# // -- API Gateway
# resource "google_project_service" "APIgateway" {
#   project                    = local.project_id
#   service                    = "apigateway.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }
# resource "google_project_service" "ServiceManagement" {
#   project                    = local.project_id
#   service                    = "servicemanagement.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }
# resource "google_project_service" "ServiceControl" {
#   project                    = local.project_id
#   service                    = "servicecontrol.googleapis.com"
#   disable_on_destroy         = false
#   disable_dependent_services = false
# }

# Enab1e Cloud Build
resource "google_project_service" "cloudbuild" {
  project                    = local.project_id
  service                    = "cloudbuild.googleapis.com"
  disable_on_destroy         = false
  disable_dependent_services = false
}
# Enab1e Cloud Deploy
resource "google_project_service" "clouddeploy" {
  project                    = local.project_id
  service                    = "clouddeploy.googleapis.com"
  disable_on_destroy         = false
  disable_dependent_services = false
}
# Enab1e Cloud Source Repositories
resource "google_project_service" "sourcerepo" {
  project                    = local.project_id
  service                    = "sourcerepo.googleapis.com"
  disable_on_destroy         = false
  disable_dependent_services = false
}



// # // -------------  FIRESTORE DATABASE - NATIVE MODE -----------------------------------
// # NOT NEEDED FOR ALL LABS, THIS TAKES A WHILE TO EXECUTE
// resource "google_firestore_database" "database" {
//   project     = local.project_id
//   name        = "(default)"
//   location_id = "nam5"
//   type        = "FIRESTORE_NATIVE"
//   depends_on  = [google_project_service.firestore]
// }

// # // -------------  CLOUD STORAGE BUCKET -----------------------------------------------------------------
// # // https://cloud.google.com/load-balancing/docs/https/setup-global-ext-https-buckets#terraform
// resource "google_storage_bucket" "frontend" {
//   name     = local.frontend_bucket_name
//   location = local.region
//   project  = local.project_id
//   website {
//     main_page_suffix = "index.html"
//   }
// }
// resource "google_storage_bucket_iam_member" "frontend" {
//   bucket = google_storage_bucket.frontend.name
//   role   = "roles/storage.objectViewer"
//   member = "allUsers"
//   depends_on = [
//     google_storage_bucket.frontend
//   ]
// }

# # // -------------  LOCAL EXEC - BUILD AND UPLOAD FRONTEND TO CLOUD STORAGE -----------------------------------
# resource "null_resource" "npm_build_frontend" {
#   provisioner "local-exec" {
#     command = "cd ~/${local.app_name}/frontend && npm install && npm run build"
#   }
#   depends_on = [
#      null_resource.download_files
#   ]
#   // always run
#   triggers = {
#     always_run = "${timestamp()}"
#   }
# }
# resource "null_resource" "cloud_storage_upload_frontend" {
#   provisioner "local-exec" {
#     command = "gsutil -m cp -r ~/${local.app_name}/frontend/build/* gs://${local.frontend_bucket_name}"
#   }
#   depends_on = [
#     null_resource.npm_build_frontend,
#     google_storage_bucket.frontend
#   ]
#   // always run
#   triggers = {
#     always_run = "${timestamp()}"
#   }
# }

# # // -------------  CLOUD LOAD BALANCER FOR FRONTEND  -----------------------------------
# resource "google_compute_global_address" "frontend" {
#   name       = local.frontend_static_ip
#   project    = local.project_id
#   depends_on = [google_storage_bucket.frontend]
# }
# resource "google_compute_backend_bucket" "frontend" {
#   name        = "cymbal-backend-bucket"
#   bucket_name = google_storage_bucket.frontend.name
#   project     = local.project_id
#   enable_cdn  = false
#   depends_on = [
#     google_compute_global_address.frontend
#   ]
# }
# resource "google_compute_url_map" "frontend" {
#   name            = "cymbal-url-map"
#   default_service = google_compute_backend_bucket.frontend.self_link
#   project         = local.project_id
#   depends_on = [
#     google_compute_backend_bucket.frontend
#   ]
# }
# resource "google_compute_target_http_proxy" "frontend" {
#   name    = "cymbal-http-proxy"
#   url_map = google_compute_url_map.frontend.self_link
#   project = local.project_id
#   depends_on = [
#     google_compute_url_map.frontend
#   ]
# }
# resource "google_compute_global_forwarding_rule" "frontend" {
#   name                  = "http-lb-forwarding-rule"
#   ip_protocol           = "TCP"
#   load_balancing_scheme = "EXTERNAL_MANAGED"
#   port_range            = "80"
#   project               = local.project_id
#   target                = google_compute_target_http_proxy.frontend.id
#   ip_address            = google_compute_global_address.frontend.address
#   depends_on = [
#     google_compute_target_http_proxy.frontend
#   ]
# }


# # // ------------- ARTIFACT REGISTRY FOR CLOUD RUN ----------------------------------
# // https://cloud.google.com/artifact-registry/docs/repositories/create-repos#docker_1 
# resource "google_artifact_registry_repository" "cymbal-superstore-artifact-repo-docker" {
#   project       = local.project_id
#   location      = local.region
#   repository_id = local.app_name
#   description   = "Duet AI for App Developers"
#   format        = "DOCKER"
# }

# # // -------------  LOCAL EXEC - BUILD AND PUSH INVENTORY API DOCKER IMAGE -------------------------------------
# # NOT SURE WE NEED TO PRE_BUILD FOR EVERY LAB
# resource "null_resource" "docker_build_backend" {
#   provisioner "local-exec" {
#     command = "cd ~/${local.app_name}/backend && docker build --platform linux/amd64 -t ${local.inventory_image_url} ."
#   }
#   depends_on = [
#     null_resource.download_files
#   ]
#   // always run this on every terraform apply
#   triggers = {
#     always_run = timestamp()
#   }
  
# }
# resource "null_resource" "docker_push_backend" {
#   provisioner "local-exec" {
#     command = "docker push ${local.inventory_image_url}"
#   }
#   triggers = {
#     always_run = timestamp()
#   }
#   depends_on = [
#     null_resource.docker_build_backend,
#     google_artifact_registry_repository.cymbal-superstore-artifact-repo-docker
#   ]
# }

# # // -------------  CLOUD RUN SERVICE - INVENTORY API -----------------------------------------------------------------
# resource "google_cloud_run_v2_service" "inventory" {
#   name     = "inventory"
#   location = local.region
#   project  = local.project_id
#   ingress  = "INGRESS_TRAFFIC_ALL"

#   template {
#     containers {
#       image = local.inventory_image_url
#       env {
#         name  = "PROJECT_ID"
#         value = local.project_id
#       }
#       ports {
#         container_port = 8000
#       }
#       startup_probe {
#         initial_delay_seconds = 10
#         timeout_seconds       = 10
#         period_seconds        = 15
#         failure_threshold     = 3
#         tcp_socket {
#           port = 8000
#         }
#       }
#       liveness_probe {
#         http_get {
#           path = "/health"
#         }
#         initial_delay_seconds = 10
#         timeout_seconds       = 10
#         period_seconds        = 15
#         failure_threshold     = 3
#       }
#     }
#   }
#   depends_on = [null_resource.docker_push_backend]
# }

# resource "google_cloud_run_v2_service_iam_member" "member" {
#   location = google_cloud_run_v2_service.inventory.location
#   project  = google_cloud_run_v2_service.inventory.project
#   name     = google_cloud_run_v2_service.inventory.name
#   role     = "roles/run.invoker"
#   member   = "allUsers"
# }

#resource "google_cloud_run_v2_service_iam_member" "member" {
#   location = local.region
#   project  = local.project_id
#   name     = local.run_name
#   role     = "roles/run.invoker"
#   member   = "allUsers"
# }

